pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "wissal93/student-management:1.0"
        BUILD_TIMESTAMP = sh(script: 'date +"%Y%m%d_%H%M%S"', returnStdout: true).trim()
    }
    
    stages {
        stage('Pre-build Checks') {
            steps {
                sh '''
                    echo "=== VÃ‰RIFICATIONS PRÃ‰-BUILD ==="
                    echo "Java version:"
                    java -version 2>&1 | head -3
                    echo ""
                    echo "Docker version:"
                    docker --version
                    echo ""
                    echo "Docker info:"
                    docker info --format "Server: {{.ServerVersion}} | Containers: {{.Containers}} | Images: {{.Images}}"
                    echo ""
                    echo "Workspace:"
                    pwd
                    ls -la
                '''
            }
        }
        
        stage('Checkout Code') {
            steps {
                git branch: 'main', 
                    url: 'https://github.com/WissalMonastiri/student-management.git',
                    poll: false
                
                sh '''
                    echo "ğŸ“¦ Repository clonÃ©"
                    echo "ğŸ“ Commit: $(git log --oneline -1)"
                '''
            }
        }
        
        stage('Build Application') {
            steps {
                dir('student-management') {
                    sh '''
                        echo "ğŸ”¨ Construction Spring Boot..."
                        chmod +x mvnw
                        ./mvnw clean package -DskipTests -q
                        
                        echo "âœ… Build terminÃ©!"
                        echo "ğŸ“Š RÃ©sultats:"
                        find target -name "*.jar" -exec ls -lh {} \;
                    '''
                }
            }
        }
        
        stage('Test Application') {
            steps {
                dir('student-management') {
                    sh '''
                        echo "ğŸ§ª ExÃ©cution des tests..."
                        ./mvnw test || echo "Tests Ã©chouÃ©s ou non disponibles"
                    '''
                }
            }
            post {
                always {
                    junit 'student-management/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir('student-management') {
                    sh """
                        echo "ğŸ³ Construction image Docker..."
                        
                        # Supprimer l'ancienne image si elle existe
                        docker rmi ${DOCKER_IMAGE} 2>/dev/null || true
                        
                        # Construire la nouvelle image
                        docker build -t ${DOCKER_IMAGE} .
                        
                        echo "âœ… Image construite avec succÃ¨s!"
                        echo "ğŸ“‹ Liste des images:"
                        docker images ${DOCKER_IMAGE}
                        
                        # Inspecter l'image
                        echo "ğŸ” DÃ©tails de l'image:"
                        docker inspect ${DOCKER_IMAGE} --format 'Size: {{.Size}} bytes | Created: {{.Created}}' || true
                    """
                }
            }
        }
        
        stage('Test Docker Image') {
            steps {
                script {
                    echo "ğŸ§ª Test de l'image Docker..."
                    
                    sh """
                        # ArrÃªter tout conteneur existant
                        docker stop student-test 2>/dev/null || true
                        docker rm student-test 2>/dev/null || true
                        
                        # DÃ©marrer un conteneur de test
                        docker run -d --name student-test -p 8080:8080 ${DOCKER_IMAGE}
                        
                        # Attendre le dÃ©marrage
                        sleep 10
                        
                        # VÃ©rifier les logs
                        echo "ğŸ“ Logs du conteneur:"
                        docker logs student-test --tail 20 || true
                        
                        # VÃ©rifier si le conteneur tourne
                        if docker ps | grep -q student-test; then
                            echo "âœ… Conteneur en cours d'exÃ©cution"
                        else
                            echo "âš ï¸ Conteneur non actif"
                        fi
                        
                        # Nettoyer
                        docker stop student-test 2>/dev/null || true
                        docker rm student-test 2>/dev/null || true
                    """
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "ğŸš€ Pushing to Docker Hub..."
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            # Connexion Ã  Docker Hub
                            echo "ğŸ” Connexion en tant que \${DOCKER_USER}..."
                            echo "\${DOCKER_PASS}" | docker login -u "\${DOCKER_USER}" --password-stdin
                            
                            # Push de l'image
                            echo "ğŸ“¤ Push de ${DOCKER_IMAGE}..."
                            docker push ${DOCKER_IMAGE}
                            
                            # DÃ©connexion
                            docker logout
                            
                            echo "âœ… Push rÃ©ussi!"
                        """
                    }
                }
            }
        }
        
        stage('Verify Push') {
            steps {
                script {
                    echo "ğŸ” VÃ©rification du push..."
                    
                    sh """
                        echo "Pour vÃ©rifier sur Docker Hub:"
                        echo "ğŸ‘‰ https://hub.docker.com/r/wissal93/student-management/tags"
                        echo ""
                        echo "Pour utiliser l'image:"
                        echo "docker pull ${DOCKER_IMAGE}"
                        echo "docker run -d -p 8080:8080 ${DOCKER_IMAGE}"
                    """
                    
                    // CrÃ©er un rapport
                    sh """
                        echo "# Rapport de Build" > build-report.txt
                        echo "Build: ${BUILD_NUMBER}" >> build-report.txt
                        echo "Date: ${BUILD_TIMESTAMP}" >> build-report.txt
                        echo "Image: ${DOCKER_IMAGE}" >> build-report.txt
                        echo "Status: SUCCESS" >> build-report.txt
                    """
                    
                    archiveArtifacts artifacts: 'build-report.txt', fingerprint: true
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ§¹ Nettoyage..."
            sh '''
                # Nettoyer les ressources Docker
                docker container prune -f 2>/dev/null || true
                docker image prune -f 2>/dev/null || true
                
                echo "=== FIN DU PIPELINE ==="
            '''
            
            // Archive les artefacts
            archiveArtifacts artifacts: 'student-management/target/*.jar', fingerprint: true
        }
        
        success {
            echo """
            ğŸ‰ğŸ‰ğŸ‰ PIPELINE RÃ‰USSIE ! ğŸ‰ğŸ‰ğŸ‰
            
            ğŸ“Š RÃ‰SULTATS:
            âœ… Application Spring Boot construite
            âœ… Tests exÃ©cutÃ©s
            âœ… Image Docker construite
            âœ… Image poussÃ©e sur Docker Hub
            
            ğŸ³ IMAGE DOCKER:
            ${DOCKER_IMAGE}
            
            ğŸ”— VÃ‰RIFIER SUR:
            https://hub.docker.com/r/wissal93/student-management/tags
            
            ğŸš€ POUR DÃ‰PLOYER:
            docker pull ${DOCKER_IMAGE}
            docker run -d -p 8080:8080 ${DOCKER_IMAGE}
            """
        }
        
        failure {
            echo """
            âŒâŒâŒ PIPELINE Ã‰CHOUÃ‰E âŒâŒâŒ
            
            Consultez les logs pour plus de dÃ©tails.
            """
        }
    }
}
