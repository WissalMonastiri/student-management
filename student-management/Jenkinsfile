pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "wissal93/student-management:1.0"
        DOCKER_HUB_URL = "https://hub.docker.com/r/wissal93/student-management"
    }
    
    stages {
        stage('Check Docker Login') {
            steps {
                script {
                    // Tester la connexion Docker
                    try {
                        sh 'docker info'
                        echo "‚úÖ Docker est op√©rationnel"
                    } catch (Exception e) {
                        error "‚ùå Docker n'est pas accessible. V√©rifiez les permissions."
                    }
                }
            }
        }
        
        stage('Checkout') {
            steps {
                git 'https://github.com/WissalMonastiri/student-management.git'
                sh '''
                    echo "üì¶ Repository clon√©"
                    echo "üìç R√©pertoire: $(pwd)"
                    ls -la
                '''
            }
        }
        
        stage('Build Maven') {
            steps {
                sh '''
                    echo "üî® Construction de l'application..."
                    chmod +x mvnw
                    ./mvnw clean package -DskipTests
                    
                    echo "‚úÖ Build termin√©"
                    ls -lh target/*.jar
                '''
            }
        }
        
        stage('Build Docker Image') {
            steps {
                sh """
                    echo "üê≥ Construction de l'image Docker..."
                    
                    # V√©rifier si l'image existe d√©j√† localement
                    if docker images | grep -q "wissal93/student-management.*1.0"; then
                        echo "‚ö†Ô∏è Image existe d√©j√† localement, suppression..."
                        docker rmi wissal93/student-management:1.0 || true
                    fi
                    
                    # Construire la nouvelle image
                    docker build -t ${DOCKER_IMAGE} .
                    
                    echo "‚úÖ Image construite:"
                    docker images | grep wissal93/student-management
                    
                    # Tester l'image localement
                    echo "üß™ Test local rapide..."
                    docker run --rm ${DOCKER_IMAGE} --version || docker run --rm ${DOCKER_IMAGE} java -version || true
                """
            }
        }
        
        stage('Test Docker Login') {
            steps {
                script {
                    echo "üîê Test de connexion √† Docker Hub..."
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            # Tester la connexion
                            echo "\${DOCKER_PASS}" | docker login -u "\${DOCKER_USER}" --password-stdin
                            
                            # V√©rifier la connexion
                            echo "‚úÖ Connect√© en tant que: \${DOCKER_USER}"
                            
                            # D√©connexion imm√©diate pour le test
                            docker logout
                        """
                    }
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "üöÄ Pushing to Docker Hub..."
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            # Connexion
                            echo "\${DOCKER_PASS}" | docker login -u "\${DOCKER_USER}" --password-stdin
                            echo "üîê Connect√© √† Docker Hub"
                            
                            # Push de l'image
                            echo "üì§ Pushing ${DOCKER_IMAGE}..."
                            docker push ${DOCKER_IMAGE}
                            
                            echo "‚úÖ Push r√©ussi!"
                            
                            # V√©rifier rapidement
                            echo "üìã V√©rification:"
                            docker images ${DOCKER_IMAGE}
                            
                            # D√©connexion
                            docker logout
                            echo "üîì D√©connect√©"
                        """
                    }
                }
            }
        }
        
        stage('Verify on Docker Hub') {
            steps {
                script {
                    echo "üîç V√©rification sur Docker Hub..."
                    echo "Visitez: ${DOCKER_HUB_URL}"
                    echo "Vous devriez voir le tag '1.0'"
                    
                    // Attendre un peu pour que Docker Hub se synchronise
                    sleep 5
                    
                    // Essayer de pull pour v√©rifier
                    sh """
                        echo "üîÑ Tentative de pull pour v√©rifier..."
                        if docker pull ${DOCKER_IMAGE} 2>/dev/null; then
                            echo "üéâ SUCC√àS: L'image est disponible sur Docker Hub!"
                        else
                            echo "‚ö†Ô∏è ATTENTION: L'image n'est peut-√™tre pas encore visible"
                            echo "Cela peut prendre quelques minutes pour appara√Ætre sur le site web"
                        fi
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo "üßπ Nettoyage..."
            sh '''
                # Nettoyer les conteneurs arr√™t√©s
                docker container prune -f 2>/dev/null || true
                
                echo "=== FIN DU PIPELINE ==="
            '''
        }
        
        success {
            echo """
            üéâ PIPELINE R√âUSSIE!
            
            ‚úÖ Image Docker: ${DOCKER_IMAGE}
            ‚úÖ Disponible sur: ${DOCKER_HUB_URL}
            
            Pour utiliser l'image:
            docker pull ${DOCKER_IMAGE}
            docker run -p 8080:8080 ${DOCKER_IMAGE}
            """
        }
        
        failure {
            echo """
            ‚ùå PIPELINE √âCHOU√âE!
            
            Prochaines √©tapes:
            1. V√©rifiez vos credentials Docker Hub
            2. Testez manuellement: docker login
            3. Testez manuellement: docker push ${DOCKER_IMAGE}
            4. V√©rifiez les logs ci-dessus
            """
        }
    }
}
